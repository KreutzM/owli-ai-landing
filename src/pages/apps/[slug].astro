---
import { render, type CollectionEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getApps } from "../../lib/content";
import AppHero from "../../components/apps/AppHero.astro";
import FeatureGrid from "../../components/apps/FeatureGrid.astro";
import PrivacyCard from "../../components/apps/PrivacyCard.astro";
import RequirementsList from "../../components/apps/RequirementsList.astro";
import MediaGallery from "../../components/apps/MediaGallery.astro";
import CtaBar from "../../components/apps/CtaBar.astro";
import { localizeHref, withPrefix, type LangPrefix, type SiteLang } from "../../lib/i18n";

export async function getStaticPaths() {
  const apps = await getApps();

  return apps.map((app) => ({
    params: { slug: app.data.slug },
    props: { app }
  }));
}

interface Props {
  app: CollectionEntry<"apps">;
  lang?: SiteLang;
  pathPrefix?: LangPrefix;
}

const { app, lang = "de", pathPrefix = "" } = Astro.props;
const { Content } = await render(app);

const features = app.data.features;
const requirements = app.data.requirements;
const media = app.data.media;
const privacy = app.data.privacy;
const seoTitle = app.data.seo.title ?? `${app.data.name} (${app.data.platform})`;
const seoDescription = app.data.seo.description;
const seoKeywords = app.data.seo.keywords;
const seoOgImage = app.data.seo.ogImage ?? app.data.featureGraphic?.src ?? "/og/owli-default-og.svg";
const appPath = withPrefix(`/apps/${app.data.slug}`, pathPrefix);
const appUrl = new URL(`${appPath}/`, Astro.site ?? Astro.url).toString();
const softwareApplicationJsonLd = {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  name: app.data.name,
  operatingSystem: app.data.platform,
  applicationCategory: "AssistiveApplication",
  description: seoDescription,
  url: appUrl
};

const primaryCta = app.data.links.primary
  ? { ...app.data.links.primary, href: localizeHref(app.data.links.primary.href, pathPrefix) }
  : { label: `${app.data.name} testen`, href: withPrefix("/support", pathPrefix) };
const secondaryCta = app.data.links.secondary
  ? { ...app.data.links.secondary, href: localizeHref(app.data.links.secondary.href, pathPrefix) }
  : { label: "Zur App-Uebersicht", href: withPrefix("/apps", pathPrefix) };
---

<BaseLayout
  title={seoTitle}
  description={seoDescription}
  keywords={seoKeywords}
  ogType="article"
  ogImage={seoOgImage}
  lang={lang}
  pathPrefix={pathPrefix}
>
  <Fragment slot="head">
    <script is:inline type="application/ld+json" set:html={JSON.stringify(softwareApplicationJsonLd)} />
  </Fragment>
  <article class="space-y-8">
    <AppHero
      name={app.data.name}
      tagline={app.data.tagline}
      valueProp={app.data.valueProp || app.data.tagline}
      audience={app.data.audience}
      platform={app.data.platform}
      status={app.data.status}
      icon={app.data.icon}
      logo={app.data.logo}
    />

    {app.data.featureGraphic && (
      <figure class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <img
          src={app.data.featureGraphic.src}
          alt={app.data.featureGraphic.alt || `Feature-Grafik von ${app.data.name}`}
          width={app.data.featureGraphic.width ?? 1024}
          height={app.data.featureGraphic.height ?? 500}
          class="mx-auto h-auto w-full rounded-lg bg-slate-50 object-contain"
          loading="eager"
          decoding="async"
        />
      </figure>
    )}

    {app.data.slug === "assist" && (
      <section class="rounded-2xl border border-indigo-200 bg-indigo-50 p-5 shadow-sm">
        <h2 class="text-2xl font-semibold tracking-tight text-indigo-950">Cloud Mode im Fokus</h2>
        <ul class="mt-3 list-disc space-y-2 pl-5 text-indigo-900">
          <li>Snapshot aufnehmen und als VLM-Anfrage senden.</li>
          <li>Kontextbasierte Follow-up Fragen ohne Neustart.</li>
          <li>Auto-Scan fuer regelmaessige Szenenupdates.</li>
          <li>Voice Input fuer haendefreie Bedienung.</li>
          <li>Streaming TTS fuer schnelle Rueckmeldung.</li>
        </ul>
      </section>
    )}

    <div class="grid gap-6 lg:grid-cols-[2fr,1fr]">
      <FeatureGrid features={features} />
      <PrivacyCard privacy={privacy} appSlug={app.data.slug} />
    </div>

    <div class="grid gap-6 lg:grid-cols-2">
      <RequirementsList requirements={requirements} />
      <section class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
        <h2 class="text-2xl font-semibold tracking-tight">Weitere Details</h2>
        <div class="content-markdown mt-4">
          <Content />
        </div>
      </section>
    </div>

    <MediaGallery media={media} appName={app.data.name} />

    <CtaBar primary={primaryCta} secondary={secondaryCta} />
  </article>
</BaseLayout>
