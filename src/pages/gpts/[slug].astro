---
import type { CollectionEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import BrandLogo from "../../components/BrandLogo.astro";
import TranslationStatusBadge from "../../components/TranslationStatusBadge.astro";
import { getGpts } from "../../lib/content";
import { withPrefix, type LangPrefix, type SiteLang } from "../../lib/i18n";
import { getUiStrings } from "../../i18n/strings";

export async function getStaticPaths() {
  const gpts = await getGpts();

  return gpts.map((gpt) => ({
    params: { slug: gpt.data.slug },
    props: { gpt }
  }));
}

interface Props {
  gpt: CollectionEntry<"gpts">;
  lang?: SiteLang;
  pathPrefix?: LangPrefix;
}

const { gpt, lang = "de", pathPrefix = "" } = Astro.props;
const ui = getUiStrings(lang);
const seoTitle = gpt.data.seo.title ?? `${gpt.data.name} in ChatGPT`;
const seoDescription = gpt.data.seo.description;
const seoKeywords = gpt.data.seo.keywords;
const iconSrc = gpt.data.icon?.src;
const altCopy = {
  de: {
    gptIconFallbackPrefix: "Icon von",
    gptSymbolFallbackPrefix: "Owli-AI Symbol fuer"
  },
  en: {
    gptIconFallbackPrefix: "Icon of",
    gptSymbolFallbackPrefix: "Owli-AI symbol for"
  },
  es: {
    gptIconFallbackPrefix: "Icono de",
    gptSymbolFallbackPrefix: "Simbolo de Owli-AI para"
  }
}[lang];
const iconAlt = gpt.data.icon?.alt?.trim() || `${altCopy.gptIconFallbackPrefix} ${gpt.data.name}`;
const bodyText = gpt.body ?? "";
const wofuerMatch = bodyText.match(/##\s+Wof(?:u|ue)r ist das\?\s*([\s\S]*?)(?:\n##\s+|$)/u);
const quickstartIntro = (wofuerMatch?.[1] ?? gpt.data.shortDescription).replace(/\s+/g, " ").trim();
const whenHelpMatch = bodyText.match(/##\s+Wann hilft das\?\s*([\s\S]*?)(?:\n##\s+|$)/u);
const limitsCalloutClass =
  gpt.data.slug === "sozialberater-hessen"
    ? "border-amber-300 bg-amber-50 text-amber-950"
    : "border-sky-200 bg-sky-50 text-slate-800";
const copy = {
  de: {
    eyebrow: "Owli-AI Custom GPT",
    quickstartTitle: "Schnellstart",
    openLabel: "Oeffnen",
    openText: "Oeffne den GPT ueber den ChatGPT-Link.",
    contextLabel: "Kontext geben",
    contextText: "Beschreibe kurz deine Situation, damit der GPT zielgerichtet antworten kann.",
    askLabel: "Frage stellen",
    askText: "Starte mit einer konkreten Frage oder Aufgabe.",
    promptsTitle: "Beispiel-Prompts",
    typicalTitle: "Typische Fragen",
    limitsTitle: "Grenzen und Datenschutz",
    limitsAria: "Hinweis zu Grenzen und Datenschutz",
    noticeLabel: "Wichtiger Hinweis",
    useCasePromptPrefix: "Bitte unterstuetze mich dabei",
    questionPromptPrefix: "Bitte starte mit dieser Frage",
    tagsAria: "Tags"
  },
  en: {
    eyebrow: "Owli-AI Custom GPT",
    quickstartTitle: "Quick start",
    openLabel: "Open",
    openText: "Open the GPT via the ChatGPT link.",
    contextLabel: "Add context",
    contextText: "Briefly describe your situation so the GPT can respond in a focused way.",
    askLabel: "Ask a question",
    askText: "Start with a specific question or task.",
    promptsTitle: "Example prompts",
    typicalTitle: "Typical questions",
    limitsTitle: "Limits and privacy",
    limitsAria: "Notice about limits and privacy",
    noticeLabel: "Important notice",
    useCasePromptPrefix: "Please help me with this",
    questionPromptPrefix: "Please start with this question",
    tagsAria: "Tags"
  },
  es: {
    eyebrow: "Owli-AI GPT personalizado",
    quickstartTitle: "Inicio rapido",
    openLabel: "Abrir",
    openText: "Abre el GPT mediante el enlace de ChatGPT.",
    contextLabel: "Dar contexto",
    contextText: "Describe brevemente tu situacion para que el GPT responda de forma mas precisa.",
    askLabel: "Hacer una pregunta",
    askText: "Comienza con una pregunta o tarea concreta.",
    promptsTitle: "Prompts de ejemplo",
    typicalTitle: "Preguntas tipicas",
    limitsTitle: "Limites y privacidad",
    limitsAria: "Aviso sobre limites y privacidad",
    noticeLabel: "Aviso importante",
    useCasePromptPrefix: "Por favor ayudame con esto",
    questionPromptPrefix: "Por favor empieza con esta pregunta",
    tagsAria: "Etiquetas"
  }
}[lang];
const useCasePrompts = (whenHelpMatch?.[1] ?? "")
  .split("\n")
  .map((line) => line.trim())
  .filter((line) => line.startsWith("- "))
  .map((line) => line.replace(/^-+\s*/, "").trim())
  .map((line) => line.replace(/[.!?]\s*$/u, ""))
  .slice(0, 3)
  .map((useCase) => `${copy.useCasePromptPrefix}: ${useCase}.`);
const quickstartPrompts =
  gpt.data.examplePrompts.length > 0
    ? gpt.data.examplePrompts.slice(0, 3)
    : useCasePrompts.length > 0
      ? useCasePrompts
      : gpt.data.typicalQuestions.slice(0, 3).map((question) => `${copy.questionPromptPrefix}: ${question}`);
---

<BaseLayout title={seoTitle} description={seoDescription} keywords={seoKeywords} lang={lang} pathPrefix={pathPrefix}>
  <article class="space-y-8">
    <header class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm sm:p-8">
      <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-600">{copy.eyebrow}</p>
      <div class="mt-3 flex flex-wrap items-center gap-4">
        {
          iconSrc ? (
            <img
              src={iconSrc}
              alt={iconAlt}
              width={gpt.data.icon?.width ?? 64}
              height={gpt.data.icon?.height ?? 64}
              class="h-16 w-16 rounded-xl object-contain drop-shadow-sm"
              loading="lazy"
              decoding="async"
            />
          ) : (
            <BrandLogo
              alt={`${altCopy.gptSymbolFallbackPrefix} ${gpt.data.name}`}
              width={64}
              height={64}
              className="h-16 w-16 rounded-xl object-contain drop-shadow-sm"
            />
          )
        }
        <h1 class="text-3xl font-semibold leading-tight tracking-tight sm:text-4xl">{gpt.data.name}</h1>
      </div>
      <p class="mt-4 text-base text-slate-700">{gpt.data.shortDescription}</p>
      <div class="mt-4">
        <TranslationStatusBadge lang={lang} translationStatus={gpt.data.translationStatus} />
      </div>
      <ul class="mt-4 flex flex-wrap gap-2" aria-label={copy.tagsAria}>
        {
          gpt.data.audienceBadges.map((badge) => (
            <li>
              <span class="badge-platform rounded-full px-3 py-1 text-xs font-semibold">{badge}</span>
            </li>
          ))
        }
      </ul>
    </header>

    <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm sm:p-8" aria-labelledby="schnellstart-title">
      <h2 id="schnellstart-title" class="text-2xl font-semibold tracking-tight">{copy.quickstartTitle}</h2>
      <p class="mt-3 text-slate-700">
        {quickstartIntro}
      </p>
      <ol class="mt-4 space-y-3 text-slate-700">
        <li>
          <span class="font-semibold">{copy.openLabel}:</span> {copy.openText}
        </li>
        <li>
          <span class="font-semibold">{copy.contextLabel}:</span> {copy.contextText}
        </li>
        <li>
          <span class="font-semibold">{copy.askLabel}:</span> {copy.askText}
        </li>
      </ol>
      {quickstartPrompts.length > 0 && (
        <>
          <h3 class="mt-5 text-lg font-semibold tracking-tight">{copy.promptsTitle}</h3>
          <ul class="mt-2 list-disc space-y-2 pl-5 text-slate-700">
            {quickstartPrompts.map((prompt) => <li>{prompt}</li>)}
          </ul>
        </>
      )}
    </section>

    <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm sm:p-8" aria-labelledby="typische-fragen-title">
      <h2 id="typische-fragen-title" class="text-2xl font-semibold tracking-tight">{copy.typicalTitle}</h2>
      <ul class="mt-3 list-disc space-y-2 pl-5 text-slate-700">
        {gpt.data.typicalQuestions.map((question) => <li>{question}</li>)}
      </ul>
    </section>

    <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm sm:p-8" aria-labelledby="grenzen-title">
      <h2 id="grenzen-title" class="text-2xl font-semibold tracking-tight">{copy.limitsTitle}</h2>
      <aside class:list={["mt-3 rounded-xl border p-4", limitsCalloutClass]} aria-label={copy.limitsAria}>
        <p class="text-sm font-semibold uppercase tracking-wide">{copy.noticeLabel}</p>
        <p class="mt-2 text-base">{gpt.data.limits}</p>
      </aside>
    </section>

    <section class="space-y-2">
      <div class="flex flex-wrap gap-3">
        <a
          href={gpt.data.link}
          target="_blank"
          rel="noopener noreferrer"
          class="btn-brand inline-flex items-center rounded-full border px-5 py-2.5 text-sm font-semibold transition"
        >
          {ui.cta.openInChatGpt}
        </a>
        <a
          href={withPrefix("/gpts", pathPrefix)}
          class="btn-outline-neutral inline-flex items-center rounded-full border px-5 py-2.5 text-sm font-semibold transition"
        >
          {ui.cta.back}
        </a>
      </div>
      <p class="text-sm text-slate-600">{ui.notices.requiresChatGptAccount}</p>
    </section>
  </article>
</BaseLayout>
